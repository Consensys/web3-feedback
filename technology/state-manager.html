<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-technology/state-manager" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">EVM state manager | Linea</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" property="og:url" content="https://consensys.github.io/web3-feedback/technology/state-manager"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="EVM state manager | Linea"><meta data-rh="true" name="description" content="How state management works on Linea"><meta data-rh="true" property="og:description" content="How state management works on Linea"><meta data-rh="true" property="og:image" content="https://consensys.github.io/web3-feedback/img/socialCards/evm-state-manager.jpg"><meta data-rh="true" name="twitter:image" content="https://consensys.github.io/web3-feedback/img/socialCards/evm-state-manager.jpg"><link data-rh="true" rel="icon" href="/web3-feedback/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://consensys.github.io/web3-feedback/technology/state-manager"><link data-rh="true" rel="alternate" href="https://consensys.github.io/web3-feedback/technology/state-manager" hreflang="en"><link data-rh="true" rel="alternate" href="https://consensys.github.io/web3-feedback/technology/state-manager" hreflang="x-default"><link rel="preconnect" href="https://www.googletagmanager.com">
<script>window.dataLayer=window.dataLayer||[]</script>
<script>!function(e,t,a,n){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var g=t.getElementsByTagName(a)[0],m=t.createElement(a);m.async=!0,m.src="https://www.googletagmanager.com/gtm.js?id=GTM-TB58STH",g.parentNode.insertBefore(m,g)}(window,document,"script","dataLayer")</script>



<script>window.lightningjs||function(n){function e(e,t){var i,r,a,o,d,l;return t&&(t+=(/\?/.test(t)?"&":"?")+"lv=1"),n[e]||(i=window,r=document,a=e,o=r.location.protocol,d="load",l=0,function(){n[a]=function(){var t=arguments,r=this,o=++l,d=r&&r!=i&&r.id||0;function s(){return s.id=o,n[a].apply(s,arguments)}return(e.s=e.s||[]).push([o,d,t]),s},s};var e=n[a]._={};function s(){e.P(d),e.w=1,n[a]("_load")}e.fh={},e.eh={},e.ph={},e.l=t?t.replace(/^\/\//,("https:"==o?o:"http:")+"//"):t,e.p={0:+new Date},e.P=function(n){e.p[n]=new Date-e.p[0]},e.w&&s(),i.addEventListener?i.addEventListener(d,s,!1):i.attachEvent("onload",s);var c=function(){function n(){return["<!DOCTYPE ",o,"><",o,"><head></head><",t,"><",i,' src="',e.l,'"></',i,"></",t,"></",o,">"].join("")}var t="body",i="script",o="html",d=r[t];if(!d)return setTimeout(c,100);e.P(1);var l,s=r.createElement("div"),h=s.appendChild(r.createElement("div")),u=r.createElement("iframe");s.style.display="none",d.insertBefore(s,d.firstChild).id="lightningjs-"+a,u.frameBorder="0",u.id="lightningjs-frame-"+a,/MSIE[ ]+6/.test(navigator.userAgent)&&(u.src="javascript:false"),u.allowTransparency="true",h.appendChild(u);try{u.contentWindow.document.open()}catch(n){e.domain=r.domain,l="javascript:var d=document.open();d.domain='"+r.domain+"';",u.src=l+"void(0);"}try{var p=u.contentWindow.document;p.write(n()),p.close()}catch(e){u.src=l+'d.write("'+n().replace(/"/g,String.fromCharCode(92)+'"')+'");d.close();'}e.P(2)};e.l&&c()}()),n[e].lv="1",n[e]}var t=window.lightningjs=e("lightningjs");t.require=e,t.modules=n}({}),window.usabilla_live=lightningjs.require("usabilla_live","//w.usabilla.com/28fb46af8693.js");</script>
<script>document.addEventListener("DOMContentLoaded",(function(){var e=document.getElementById("__cookbook");e||((e=document.createElement("div")).id="__cookbook",e.dataset.apiKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2NWMxOGU4YTA1MjA1MDZmZmEwMDhjNDYiLCJpYXQiOjE3MDcxODM3NTQsImV4cCI6MjAyMjc1OTc1NH0.tHX7blsbehxRJIjCQMMBxWpdjDCHiRW5sr8vkyefHVs",document.body.appendChild(e));var o=document.getElementById("__cookbook-script");o||((o=document.createElement("script")).crossOrigin="anonymous",o.integrity="sha384-2IAGy0MWIbMc3D8cuK6NbOkLIz4yy3pYmImC4f6TRKhfFMNEo1nFCQ2re8bysHkX",o.src="https://cdn.jsdelivr.net/npm/@cookbookdev/docsbot@4.21.17/dist/standalone/index.cjs.js",o.id="__cookbook-script",o.async=!0,document.body.appendChild(o))}))</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous">
<script src="/js/getfeedback.js" defer="defer" async></script>
<script src="/js/navbarHighlight.js" defer="defer"></script><link rel="stylesheet" href="/web3-feedback/assets/css/styles.711d426e.css">
<script src="/web3-feedback/assets/js/runtime~main.498c893f.js" defer="defer"></script>
<script src="/web3-feedback/assets/js/main.b2f031b9.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?t("light"):t("dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script>

<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TB58STH" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/web3-feedback/"><div class="navbar__logo"><img src="/web3-feedback/img/Linea_docs_logo.svg" alt="Linea" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/web3-feedback/img/Linea_docs_logo.svg" alt="Linea" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Docs</b></a><a class="navbar__item navbar__link" href="/web3-feedback/get-started">Get started</a><a class="navbar__item navbar__link" href="/web3-feedback/learn/marketplace-dapp">Learn</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/web3-feedback/technology/architecture">Technology</a><a class="navbar__item navbar__link" href="/web3-feedback/api/linea-smart-contracts/linearollup">APIs &amp; SDK</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/web3-feedback/release-notes">Release notes</a><a href="https://discord.gg/linea" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link" class="support-link">Support<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><button class="connectButton_dM8g">Connect MetaMask</button><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)" aria-live="polite" aria-pressed="true"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/web3-feedback/technology/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/web3-feedback/technology/decentralization">Decentralization roadmap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/web3-feedback/technology/repos">Linea repositories</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/web3-feedback/technology/transaction-lifecycle">Transaction lifecycle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/web3-feedback/technology/network-data">Network data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/web3-feedback/technology/canonical-token-bridge">Canonical token bridge</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/web3-feedback/technology/message-service">Canonical message service</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/web3-feedback/technology/coordinator">Coordinator</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link" href="/web3-feedback/technology/sequencer">Sequencer</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/web3-feedback/technology/sequencer/conflation">Conflation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/web3-feedback/technology/sequencer/traces-generator">Traces generation</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/web3-feedback/technology/state-manager">EVM state manager</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link" href="/web3-feedback/technology/prover">Prover</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/web3-feedback/technology/prover/proving">Proving: Circuit execution and runtime</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/web3-feedback/technology/prover/trace-expansion">Proving: Circuit building</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/web3-feedback/technology/prover/prover-limits">Module limits</a></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/web3-feedback/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">EVM state manager</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>EVM state manager</h1></header><p>The state manager is the part of the execution client responsible for updating the state of the
network globally, and the state of every account individually. The state manager also audits the
&quot;read&quot; access made in the EVM, meaning it monitors, verifies, and logs all operations where the
EVM needs to read data from the blockchain state.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>&quot;State&quot; refers to the data stored on the blockchain at any given point in time. To
update state is to update the record of the contents of every account whose contents have
changed.</p></div></div>
<p>The main task of the state manager is to receive blocks that have been executed by the <a href="/web3-feedback/technology/sequencer">sequencer</a>
and use the trace data from their execution to update the state of the network. Linea uses two
data structure types to manage state:</p>
<ol>
<li>A Merkle-Patricia Trie to record the world state, maintain consensus, and process blocks. This
mirrors how consensus and state are <a href="https://ethereum.org/en/developers/docs/data-structures-and-encoding/patricia-merkle-trie/" target="_blank" rel="noopener noreferrer">managed on Ethereum Mainnet</a>.</li>
<li>A variant of regular Merkle trees called a sparse Merkle tree (SMT), which is used to more
efficiently track, manage, and update storage slots representing accounts.</li>
</ol>
<p>It then passes this updated network state information to the <a href="/web3-feedback/technology/prover">prover</a>
in the form of Merkle proofs for submission to Ethereum Mainnet (L1).</p>
<p>Below, we&#x27;ll explain the element of Linea&#x27;s state management in greater detail, focussing on the
SMT configuration that sets Linea apart.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="merkle-trees">Merkle trees<a href="#merkle-trees" class="hash-link" aria-label="Direct link to Merkle trees" title="Direct link to Merkle trees">​</a></h2>
<p>The Merkle tree and its variations are commonly used across EVM chains to store and retrieve
data about the state of every account on the blockchain.</p>
<p>A Merkle tree is comprised of &#x27;nodes&#x27; that branch off from each other. At the base is the &#x27;root&#x27;,
or state root, from which branches stem, and leaves stem from the branches.</p>
<div class="img-large"><div class="mermaid-medium"></div></div>
<p>Each node, regardless of type, is represented by a cryptographic hash which encodes data about its
properties — for example, the contents of your account. Each hash encodes the hashes of its child
nodes. Taken to its full extent, this cascading system means the root encodes data of the state of
every single account on the blockchain.</p>
<p>Cryptographic hashes are deterministic, which means you can reverse the hash function to get the
data which it encoded. If you have the hash of the root—the only node without a parent—you can
theoretically derive from it the data of any node in the entire tree.</p>
<p>As a layer 2 (L2) network, Linea is in the business of making transacting faster and more efficient.
Linea implements a sparse Merkle tree to track account state and generate and store proofs, and
unlock greater efficiency when compared to standard Merkle trees, which require recomputation for
every block, leading to excessive computational demands.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sparse-merkle-trees">Sparse Merkle trees<a href="#sparse-merkle-trees" class="hash-link" aria-label="Direct link to Sparse Merkle trees" title="Direct link to Sparse Merkle trees">​</a></h3>
<p>Linea&#x27;s state management uses sparse Merkle trees to minimize computation and contribute to the
blockchain&#x27;s efficiency.</p>
<p>A sparse Merkle tree is a variation of a standard Merkle tree where not all leaf nodes are filled
with data; instead, data is only stored in nodes where it&#x27;s needed. It is a complete tree of fixed
depth, meaning that all branches of the tree have the same length—i.e. the same number of leaves.</p>
<p>At initialization—the beginning of the chain&#x27;s history—all leaf nodes are set to a default value,
which is typically a hash of a specific value, such as zero. Because all leaf nodes have the same
hash value, the parent nodes and higher-level nodes also have the same hash value. A node whose
hash is the default value for its level is therefore considered to represent an <em>empty</em> subtree.</p>
<div class="center-container"><div class="mermaid-medium"></div></div>
<p>In the example above, the children of node A (leaves) contain null values, which means node A does
too. Node B, meanwhile, reflects that its children also contain values.</p>
<p>With this construction, we do not need to keep track of every individual node&#x27;s hash. Instead, we
can assume hashes that reflect the default value are empty, and the subtree or node that lies
further down the chain of nodes can be disregarded; we only need to pay attention to the ones that
correspond to <em>non-empty</em> subtrees.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cryptographic-accumulator">Cryptographic accumulator<a href="#cryptographic-accumulator" class="hash-link" aria-label="Direct link to Cryptographic accumulator" title="Direct link to Cryptographic accumulator">​</a></h2>
<p>In this context, we can consider Linea&#x27;s sparse Merkle tree as a type of &quot;cryptographic
accumulator&quot;. A cryptographic accumulator is a type of cryptographic primitive encoding a collection
of items into very short strings and allowing read/write operations to be proven. Merkle trees and
sparse Merkle trees are elementary examples of accumulators but there are others with more powerful
capabilities.</p>
<p>Linea&#x27;s state manager uses an extended version of a sparse Merkle tree that enables it to prove all
CRUD (create, read, update, delete) operations for a key-addressed database. As an outline, the
construction uses a sparse Merkle tree to store the nodes of a sorted doubly-linked list that
encodes all the non-zero items of the state.</p>
<p>Linea&#x27;s state manager uses the accumulator to track the account trie of Linea but also the storage
of every contract separately.</p>
<p>The leaves of the tree have the following structure: <code>prev || next || hKey || hVal</code>.</p>
<p><code>hKey</code> and <code>hVal</code> are the hashes of the key and the value of the stored state entry, respectively.
<code>prev</code> and <code>next</code> are pointers storing the position of the leaves whose <code>hKeys</code> are immediately
lower and higher, respectively, following lexicographic order. The first two leaves of the SMT are
called the head and the tail, and are special in that they do not encode a stored tuple. The head is
the lowest possible <code>hKey</code>, while the tail is the highest possible <code>hKey</code>. They are therefore
situated at the beginning and the end of the linked list, respectively. Starting from the head, we
can access the SMT leaf stored at <code>head.next</code> to get the lowest &quot;actually stored&quot; item. Further
incrementing the <code>next</code> value will give us the second-lowest stored item and so on. Repeating the
process walks us through the entire set of stored items before we end up at the tail node, marking
the final step.</p>
<p>Leaves can also be referred to as storage slots, in that they contain data about the contents of
the account in question.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tracking-empty-leaves">Tracking empty leaves<a href="#tracking-empty-leaves" class="hash-link" aria-label="Direct link to Tracking empty leaves" title="Direct link to Tracking empty leaves">​</a></h3>
<p>All leaves in the tree are populated with default/zero values at initialization. Since a
deterministic hashing function will ensure that these leaves are always represented by the same
hash, empty leaves can be easily recognized by the accumulator.</p>
<p>However, in order for the state manager to update a storage slot with data about a Linea account&#x27;s
contents, it must know which empty leaf to overwrite, and exactly where these empty leaves are. A
further consideration is that we require the index of any &#x27;new&#x27; leaf—an empty leaf being updated
so that it stores data—to be overwritten in a deterministic way. This requirement means that anyone
can theoretically reconstruct the tree simply by looking at transaction history.</p>
<p>To ensure consistency in the leaves&#x27; position, the state manager only ever inserts &#x27;new&#x27; leaves to
the left of the previous leaf in the tree. If this wasn&#x27;t the case, and the state manager was able
to insert any node in any position, it would be impossible to reconstitute the tree in the exact
same configuration, severely impacting the ability of L1 to verify the Merkle proof provided.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="applying-the-accumulator">Applying the accumulator<a href="#applying-the-accumulator" class="hash-link" aria-label="Direct link to Applying the accumulator" title="Direct link to Applying the accumulator">​</a></h2>
<p>The Ethereum Virtual Machine (EVM) uses a variant of a Merkle tree known as a <a href="https://ethereum.org/en/developers/docs/data-structures-and-encoding/patricia-merkle-trie/" target="_blank" rel="noopener noreferrer">Merkle-Patricia Trie</a> to track:</p>
<ul>
<li>World state, which keeps track of accounts, and;</li>
<li>Account storage state (or simply &#x27;storage&#x27;), which keeps track of the contents of each account.</li>
</ul>
<p>On Linea, we adapt this structure. The Merkle-Patricia Trie is still used for world state, but the
custom cryptographic accumulator described above is used for account storage state.</p>
<p>The accumulator can perform the following operations:</p>
<ul>
<li><strong>Insertion</strong>: adding a new storage slot to the tree, triggered by storing a non-zero value in a
previously zero-valued slot.</li>
<li><strong>Update</strong>: changing the value of an existing storage slot in the tree, triggered by storing a new
non-zero value in a previously non-zero slot.</li>
<li><strong>Deletion</strong>: removing a storage slot from the tree, triggered by storing the zero value in a
previously non-zero slot.</li>
<li><strong>Read zero</strong>: proving non-membership, triggered when a storage slot has been accessed, but not
updated, and its value is zero.</li>
<li><strong>Read non-zero</strong>: proving membership, triggered when a storage slot has been accessed, but not
updated and its value is non-zero.</li>
</ul>
<p>These operations are applied to two trees; <a href="#world-state">world state</a> and <a href="#account-storage-state">account storage state</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="world-state">World state<a href="#world-state" class="hash-link" aria-label="Direct link to World state" title="Direct link to World state">​</a></h3>
<p>The world state tree maps all accounts that exist on the blockchain—contracts and externally-owned
accounts (EOAs)—and points towards the account storage state for each. While on Ethereum Mainnet,
this data is stored in a standard trie, Linea uses the accumulator to map accounts as key<!-- -->:value<!-- -->
pairs. Otherwise, the implementation is similar to the EVM.</p>
<p>Their structure is as follows:</p>
<ul>
<li><code>HKey</code>: Hash(<code>address</code>)</li>
<li><code>Val</code>: Hash(<code>nonce</code>, <code>balance</code>, <code>storageRoot</code>, <code>codeHash</code>, <code>keccakCodeHash</code>, <code>CodeSize</code>)</li>
</ul>
<p>Critically, every piece of data fed into the <code>Val</code> (value) hash function must have a finite field
interpretation. The data must be formatted this way to enable the Linea prover to correctly
access the world state when verifying proofs. Each element is formatted as follows (all elements
require one field, other than <code>keccakCodeHash</code>):</p>
<ul>
<li><code>nonce</code>: The nonce is written in big-endian form into a <code>byte32</code>. For instance if the nonce is 10,
then the nonce should be encoded as <code>0x000000000000000000000000000000000000000000000000000000000000000a</code>.</li>
<li><code>balance</code>: Formatted the same as the nonce; big-endian <code>byte32</code>.</li>
<li><code>storageRoot</code>: The storage root should <em>not</em> be the Keccak of the Patricia trie root as in the
EVM, but the “custom Merkle tree” root of the account storage state that we describe in the
<a href="#account-storage-state">following section</a>.</li>
<li><code>codeHash</code>: The code hash should not be the Keccak of the code, it should instead be the one
obtained as described in the following section.</li>
<li>2 field elements for <code>keccakCodeHash</code>: One for the 128 most significant bits and one for the 128
least significant bits. The Keccak code hash corresponds exactly to the Keccak hash as specified by
the EVM (i.e. the output of <a href="https://eips.ethereum.org/EIPS/eip-1052" target="_blank" rel="noopener noreferrer">EXTCODEHASH</a>. We keep the
Keccak and the “custom” version for practical reasons.</li>
<li><code>codeSize</code>: The code size should be the same value as that returned by the CODESIZE/EXTCODESIZE
opcodes.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="account-storage-state">Account storage state<a href="#account-storage-state" class="hash-link" aria-label="Direct link to Account storage state" title="Direct link to Account storage state">​</a></h3>
<p>Also referred to as the storage trie, the account storage state is the database the state manager
accesses to retrieve data about the contents of accounts. Account storage is mainly relevant for
contract accounts; for EOAs, the data about assets and transactions is stored in the <a href="#world-state">world state</a>
<code>Val</code>, and the <code>codeHash</code> and its variants are empty.</p>
<p>Since the main function of account storage is to record contracts in such a way that they can be
easily retrieved and processed, it must efficiently encode the contract. It does this using the
following format:</p>
<ul>
<li><code>HKey</code>: Hash(<code>StorageKeyMSB</code>, <code>StorageKeyLSB</code>)</li>
<li><code>Val</code>: Hash(<code>StorageValueMSB</code>, <code>StorageValueLSB</code>)</li>
</ul>
<p>In both cases, the <code>MSB</code> refers to the first 16 bytes of a &#x27;word&#x27;, and <code>LSB</code> the last 16. &#x27;Word&#x27; in
this context refers to the natural unit of data used by the EVM, which is 256-bit (32 byte) chunks.</p>
<p>For example, if the data regarding a contract&#x27;s code was encoded in a <code>byte32</code>, the standard data
type for words on the EVM and equivalents like Linea, it might look like this:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[a0, a1, a2, …., a15, b0, b1, …, b15]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>That <code>byte32</code> would be split into an <code>MSB</code> and <code>LSB</code> like this:</p>
<ul>
<li><code>MSB</code>: <code>[0, 0, .., 0, a0, a1, a2, a3, .., a15]</code></li>
<li><code>LSB</code>: <code>[0, 0, .., 0, b0, b1, b2, b3, .., b15]</code></li>
</ul>
<p>The <code>MSB</code> takes the first 16 bytes, and the <code>LSB</code> the second 16 bytes.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="generating-state-root-transition-witnesses">Generating state-root-transition witnesses<a href="#generating-state-root-transition-witnesses" class="hash-link" aria-label="Direct link to Generating state-root-transition witnesses" title="Direct link to Generating state-root-transition witnesses">​</a></h2>
<p>The accumulator, built using a sparse Merkle tree, is simultaneously:</p>
<ul>
<li>A data structure on which we can perform operations;</li>
<li>A dataset that we can summarize using a short string at any time (i.e. the root hash);</li>
<li>A tool that can be used by the Linea protocol to verify that a given operation triggered a
transition from hash A to hash B.</li>
</ul>
<p>Once the accumulator has processed the trace information it receives about a new block and updated
state accordingly, it can pass a new state root hash to the prover, via the coordinator. The state
root hash can then be used by the prover as a &quot;witness&quot;: a verifiable method of proving that the
transactions in each block have taken place, without having to divulge the nature of those
transactions.</p></div><div class="feedbackContainer_C8Ks"><div class="feedbackPrompt_UaEh"><span>Was this page helpful?</span><div class="feedbackButtons_X7j4"><button class="feedbackButton_ht6A thumbsUp_trTO" aria-label="Thumbs up">👍</button><button class="feedbackButton_ht6A thumbsDown_spKh" aria-label="Thumbs down">👎</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/Consensys/doc.linea/tree/main/docs/technology/state-manager.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-04-30T09:31:29.000Z" itemprop="dateModified">Apr 30, 2025</time></b> by <b>Joel Willmore</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/web3-feedback/technology/sequencer/traces-generator"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Traces generation</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/web3-feedback/technology/prover"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Trace Expansion and Proving</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#merkle-trees" class="table-of-contents__link toc-highlight">Merkle trees</a><ul><li><a href="#sparse-merkle-trees" class="table-of-contents__link toc-highlight">Sparse Merkle trees</a></li></ul></li><li><a href="#cryptographic-accumulator" class="table-of-contents__link toc-highlight">Cryptographic accumulator</a><ul><li><a href="#tracking-empty-leaves" class="table-of-contents__link toc-highlight">Tracking empty leaves</a></li></ul></li><li><a href="#applying-the-accumulator" class="table-of-contents__link toc-highlight">Applying the accumulator</a><ul><li><a href="#world-state" class="table-of-contents__link toc-highlight">World state</a></li><li><a href="#account-storage-state" class="table-of-contents__link toc-highlight">Account storage state</a></li></ul></li><li><a href="#generating-state-root-transition-witnesses" class="table-of-contents__link toc-highlight">Generating state-root-transition witnesses</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Links</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://linea.build/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Home<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://linea.statuspage.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Status<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://lineascan.build" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mainnet block explorer<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/web3-feedback/risk-disclosures">Risk disclosures</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/linea" target="_blank" rel="noopener noreferrer" class="footer__link-item">Join our Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://support.linea.build/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Get support</a></li><li class="footer__item"><a href="https://community.linea.build/c/feedback" target="_blank" rel="noopener noreferrer" class="footer__link-item">Give feedback</a></li></ul></div><div class="col footer__col"><div class="footer__title">Contribute</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/Consensys/doc.linea" target="_blank" rel="noopener noreferrer" class="footer__link-item">Documentation<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Consensys, Inc.</div></div></div></footer></div>
</body>
</html>